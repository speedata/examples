<?xml version="1.0" encoding="UTF-8"?>
<Layout
  xmlns="urn:speedata.de:2009/publisher/en"
  xmlns:sd="urn:speedata:2009/publisher/functions/en">

  <Options show-grid="no" trace="no" ignoreeol="yes" startpage="129"/>

  <Pageformat width="148mm" height="210mm"/>
  <SetGrid width="2mm" height="9pt"/>
  <SetVariable variable="rulewd" select="'0.3pt'"/>

  <LoadFontfile name="ILShakeFest" filename="ILShakeFest.ttf" />
  <LoadFontfile name="UglyQua-Italic" filename="UglyQua-Italic.ttf" />
  <LoadFontfile name="UglyQua" filename="UglyQua.ttf" />

  <DefineFontfamily name="text" fontsize="7.5" leading="9">
    <Regular fontface="UglyQua"/>
    <Italic fontface="UglyQua-Italic"/>
  </DefineFontfamily>

  <DefineFontfamily name="title" fontsize="11" leading="13">
    <Regular fontface="UglyQua-Italic"/>
  </DefineFontfamily>

  <DefineFontfamily name="initial" fontsize="27" leading="27">
    <Regular fontface="UglyQua"/>
  </DefineFontfamily>

  <DefineTextformat name="center" alignment="centered" widow="yes" orphan="yes"/>
  <DefineTextformat name="indent" indentation="3mm" alignment="leftaligned" widow="yes" orphan="yes"/>


  <Pagetype name="main" test="true()">
    <Margin left="2mm" right="2mm" top="2mm" bottom="4mm"/>
    <PositioningArea name="text">
      <PositioningFrame column="2" row="3" height="61" width="33"/>
      <PositioningFrame column="39" row="3" height="61" width="33"/>
    </PositioningArea>
    <AtPageCreation>
      <!-- the first row for the vertical rule between the two columns. 3 is the default -->
      <SetVariable variable="firstrow" select="3"/>
      <!-- the background frame -->
      <PlaceObject row="1.3" column="1" allocate="no">
        <Frame framecolor="black" rulewidth="{$rulewd}">
          <Box width="{sd:number-of-columns() - 1}" height="{sd:number-of-rows() - 1 }" backgroundcolor="white" />
        </Frame>
      </PlaceObject>

      <!-- page number -->
      <PlaceObject column="2" row="2">
        <Table width="{sd:number-of-columns() - 3}" stretch="max">
          <Tr>
            <Td padding-bottom="3pt" padding-right="10pt" align="right">
              <Paragraph>
                <Value select="sd:current-page()"/>
              </Paragraph>
            </Td>
          </Tr>
          <Tablerule rulewidth="{$rulewd}" />
        </Table>
      </PlaceObject>
    </AtPageCreation>
    <AtPageShipout>
      <!-- the vertical rule between the two columns -->
      <PlaceObject row="{$firstrow + 1}" column="37" allocate="no">
        <Rule length="{sd:number-of-rows() - $firstrow - 1}" direction="vertical" rulewidth="{$rulewd}"/>
      </PlaceObject>
    </AtPageShipout>
  </Pagetype>

  <!-- Processing starts here, as data is the root element in the data.xml file -->
  <Record element="data">

    <!-- The title image and the head -->
    <PlaceObject column="2">
      <Table stretch="max" width="{sd:number-of-columns() - 3}" padding="5pt">
        <Tr>
          <Td align="center">
            <Image file="jc-title-flourish.pdf" width="{sd:number-of-columns() - 10}" />
          </Td>
        </Tr>
        <Tablerule rulewidth="{$rulewd}" />
        <Tr>
          <Td align="center">
            <Paragraph fontface="title"><Value select="head"/></Paragraph>
          </Td>
        </Tr>
        <Tablerule rulewidth="{$rulewd}" />
        <Tablerule rulewidth="9pt" color="white" />
      </Table>
    </PlaceObject>
    <NextRow area="text"/>

    <!-- The vertical rule should start here, right after the head. It gets drawn in
         the page master "main" -->
    <SetVariable variable="firstrow" select="sd:current-row('text')"/>
    <ProcessNode select="*"/>
  </Record>

  <!-- centered text for describing the stage -->
  <Record element="stage">
    <PlaceObject column="1" area="text">
      <Textblock>
        <Paragraph textformat="center" fontface="text">
          <I><Value select="."/></I>
        </Paragraph>
      </Textblock>
    </PlaceObject>
    <NextRow area="text" rows="3"/>
  </Record>

  <Record element="speaker">
    <!-- when center = true, we also display an initial -->
    <Switch>
      <Case test="@center='true'">
        <PlaceObject column="1" area="text">
          <Textblock>
            <Paragraph textformat="center"><I><Value select="@name"/></I></Paragraph>
          </Textblock>
        </PlaceObject>
        <NextRow area="text"/>
        <!-- we need to remember the current row as it is used in the Output below
             so the text can wrap around the initial
        -->
        <SetVariable variable="thisrow" select="sd:current-row('text')"/>

        <!-- The table takes up only the space it really needs (stretch = no) -->
        <PlaceObject row="{$thisrow}" column="1" area="text">
          <Table stretch="no" padding="0.5pt">
            <Tr>
              <Td><Paragraph fontface="initial"><Value select="@capital"/></Paragraph></Td>
            </Tr>
          </Table>
        </PlaceObject>

        <!-- The text is set with allocate="auto" to wrap around the
             table above. It must start at the same row as the table,
             not in the current row
        -->
        <Output area="text" allocate="auto" row="{$thisrow}">
          <Text>
            <Paragraph>
              <ForAll select="part">
                <Value select="."/>
              </ForAll>
            </Paragraph>
          </Text>
        </Output>
      </Case>
      <Otherwise>
        <Output area="text">
          <Text>
            <Paragraph textformat="indent" fontface="text">
              <I><Value select="@name"/><Value> </Value></I>
              <ForAll select="part">
                <Switch>
                  <Case test="@type='italic'">
                    <I><Value select="."/></I>
                  </Case>
                  <Case test="@type='stage'">
                    <Value> </Value><HSpace/><I><Value select="."/><Value>&#xA0;&#xA0;</Value></I>
                  </Case>
                  <Otherwise><Value select="."/></Otherwise>
                </Switch>
              </ForAll>
            </Paragraph>
          </Text>
        </Output>
      </Otherwise>
    </Switch>
  </Record>
</Layout>